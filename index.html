<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="mobile-web-app-capable" content="yes" />
  <title>AR - Caballo 3D</title>
  <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
  <script src="https://raw.githack.com/donmccurdy/aframe-extras/master/dist/aframe-extras.loaders.min.js"></script>
  <style>
    /* Igual que tu c√≥digo original */
  </style>
</head>
<body>
  <div class="preloader">
    <div class="spinner"></div>
    <div class="preloader-text">Cargando experiencia AR...</div>
  </div>

  <div class="instruction-panel" id="initial-instruction">
    <h2>üêé Caballo AR</h2>
    <p>Vive la experiencia de tener un caballo animado en tu espacio mediante realidad aumentada.</p>
    <button id="start-ar-btn">Comenzar Experiencia</button>
    <p id="perm-error" style="color: #f44336; display: none; margin-top: 15px;">
      No se pudo acceder a la c√°mara. Por favor, acepta el permiso para continuar.
    </p>
  </div>

  <div id="alignment-guide">
    <div class="guide-line"></div>
    <div class="guide-text">Posiciona el celular para que la vista del piso se alinee con esta l√≠nea</div>
  </div>

  <button id="show-horse-btn">Mostrar Caballo</button>

  <div class="prevent-touch" id="touch-blocker" style="display: none;"></div>

  <div id="scene-container">
    <a-scene
      vr-mode-ui="enabled: false"
      loading-screen="enabled: false"
      embedded
      arjs="sourceType: webcam; facingMode: environment; debugUIEnabled: false;"
      gesture-detector="enabled: false"
      cursor="rayOrigin: mouse"
    >
      <a-assets>
        <a-asset-item id="horse-model" src="horseRA2.glb"></a-asset-item>
      </a-assets>

      <a-entity
        id="horse-entity"
        gltf-model="#horse-model"
        position="-1 -1.5 -8"
        scale="1 1 1"
        rotation="0 90 0"
        visible="false"
        static-body
        animation-mixer="loop: repeat"
      ></a-entity>

      <a-camera position="0 0 0" cursor="fuse: false"></a-camera>
    </a-scene>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const preloader = document.querySelector(".preloader");
      const initialInstruction = document.getElementById("initial-instruction");
      const alignmentGuide = document.getElementById("alignment-guide");
      const showHorseBtn = document.getElementById("show-horse-btn");
      const sceneContainer = document.getElementById("scene-container");
      const startArBtn = document.getElementById("start-ar-btn");
      const touchBlocker = document.getElementById("touch-blocker");
      const permError = document.getElementById("perm-error");
      let horseVisible = false;
      let arStarted = false;

      const horseEntity = document.getElementById("horse-entity");
      horseEntity.setAttribute("visible", "false");

      // Simular precarga
      setTimeout(() => {
        preloader.style.display = "none";
        initialInstruction.style.display = "block";
      }, 2000);

      // Funci√≥n para solicitar permiso c√°mara expl√≠citamente
      async function requestCameraPermission() {
        try {
          // Solicitar permiso accediendo a getUserMedia sin usar flujo
          const stream = await navigator.mediaDevices.getUserMedia({ video: true });
          // Si se concede permiso, detener el stream inmediatamente (no usar)
          stream.getTracks().forEach((track) => track.stop());
          return true;
        } catch (err) {
          return false;
        }
      }

      startArBtn.addEventListener("click", async function () {
        permError.style.display = "none";
        const granted = await requestCameraPermission();
        if (granted) {
          // Ocultar panel e iniciar experiencia AR solo si permiso permitido
          initialInstruction.style.display = "none";
          sceneContainer.style.opacity = "1";
          alignmentGuide.style.display = "flex";
          showHorseBtn.style.display = "block";
          touchBlocker.style.display = "block"; // Bloquear interacciones
          arStarted = true;
          horseEntity.setAttribute("visible", "false");
          horseVisible = false;
        } else {
          // Mostrar error si permiso fue denegado
          permError.style.display = "block";
        }
      });

      showHorseBtn.addEventListener("click", function () {
        if (!horseVisible && arStarted) {
          horseEntity.setAttribute("visible", "true");
          horseVisible = true;
          alignmentGuide.style.opacity = "0";
          showHorseBtn.style.opacity = "0";
          touchBlocker.style.display = "none";

          const successMsg = document.createElement("div");
          successMsg.className = "success-message";
          successMsg.innerHTML = "‚úÖ Caballo posicionado en tu espacio";
          document.body.appendChild(successMsg);
          setTimeout(() => {
            if (successMsg.parentNode) {
              successMsg.parentNode.removeChild(successMsg);
            }
          }, 3000);
        }
      });

      const scene = document.querySelector("a-scene");
      scene.addEventListener("loaded", function () {
        const camera = document.querySelector("a-camera");
        if (camera) {
          camera.setAttribute("cursor", "fuse: false");
        }
        horseEntity.setAttribute("visible", "false");
      });

      document.addEventListener(
        "touchmove",
        function (e) {
          if (!horseVisible) {
            e.preventDefault();
          }
          if (e.touches.length > 1) {
            e.preventDefault();
          }
        },
        { passive: false }
      );

      document.addEventListener(
        "touchstart",
        function (e) {
          if (e.touches.length > 1) {
            e.preventDefault();
          }
        },
        { passive: false }
      );
    });
  </script>
</body>
</html>
