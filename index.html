<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="mobile-web-app-capable" content="yes">
  <!-- Meta espec√≠fica para iOS -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>AR - Caballo 3D</title>
  <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
  <script src="https://raw.githack.com/donmccurdy/aframe-extras/master/dist/aframe-extras.loaders.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #000;
      color: white;
      overflow: hidden;
      height: 100vh;
      touch-action: manipulation;
      -webkit-user-select: none;
      user-select: none;
    }
    
    .preloader {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #000;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    
    .preloader-text {
      color: white;
      font-size: 1.2rem;
      margin-top: 20px;
      text-align: center;
      padding: 0 20px;
    }
    
    .spinner {
      width: 50px;
      height: 50px;
      border: 5px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: #4CAF50;
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    #alignment-guide {
      position: fixed;
      top: 50%;
      left: 0;
      width: 100%;
      height: 120px;
      background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, transparent 100%);
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
      align-items: center;
      padding-bottom: 20px;
      z-index: 10;
      transition: opacity 0.5s;
    }
    
    .guide-line {
      width: 80%;
      height: 4px;
      background-color: #4CAF50;
      margin-bottom: 10px;
      border-radius: 2px;
      box-shadow: 0 0 10px rgba(76, 175, 80, 0.7);
    }
    
    .guide-text {
      color: white;
      text-align: center;
      font-size: 1rem;
      text-shadow: 0 1px 3px rgba(0,0,0,0.8);
      padding: 0 20px;
    }
    
    #show-horse-btn {
      position: fixed;
      bottom: 40px;
      left: 50%;
      transform: translateX(-50%);
      background: #4CAF50;
      color: white;
      border: none;
      padding: 15px 40px;
      font-size: 1.2rem;
      border-radius: 30px;
      cursor: pointer;
      z-index: 20;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      transition: all 0.3s;
      display: none;
    }
    
    #show-horse-btn:hover {
      background: #45a049;
      transform: translateX(-50%) scale(1.05);
    }
    
    #scene-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      opacity: 0;
      transition: opacity 1s;
    }
    
    .instruction-panel {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.8);
      padding: 25px;
      border-radius: 15px;
      text-align: center;
      z-index: 30;
      backdrop-filter: blur(10px);
      max-width: 90%;
      width: 350px;
    }
    
    .instruction-panel h2 {
      margin-bottom: 15px;
      color: #4CAF50;
    }
    
    .instruction-panel p {
      margin-bottom: 20px;
      line-height: 1.5;
    }
    
    #start-ar-btn {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 12px 30px;
      font-size: 1.1rem;
      border-radius: 30px;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    #start-ar-btn:hover {
      background: #45a049;
      transform: scale(1.05);
    }
    
    .success-message {
      position: fixed;
      top: 30px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 150, 0, 0.9);
      padding: 15px 25px;
      border-radius: 10px;
      text-align: center;
      z-index: 25;
      animation: fadeInOut 3s ease-in-out;
    }
    
    @keyframes fadeInOut {
      0% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
      20% { opacity: 1; transform: translateX(-50%) translateY(0); }
      80% { opacity: 1; transform: translateX(-50%) translateY(0); }
      100% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
    }
    
    /* Prevenir acciones t√°ctiles no deseadas */
    .prevent-touch {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 5;
    }
    
    .no-interaction {
      pointer-events: none !important;
    }
    
    /* Mensaje espec√≠fico para iOS */
    .ios-permission-help {
      display: none;
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 15px;
      border-radius: 10px;
      text-align: center;
      width: 90%;
      max-width: 400px;
      z-index: 40;
    }
    
    .ios-permission-help ul {
      text-align: left;
      margin: 10px 0;
      padding-left: 20px;
    }
    
    .ios-permission-help li {
      margin-bottom: 8px;
    }
    
    /* Indicador de carga de c√°mara */
    .camera-loading {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 35;
    }
    
    .camera-loading-text {
      color: white;
      margin-top: 20px;
      font-size: 1.1rem;
      text-align: center;
    }
  </style>
</head>
<body>
  <!-- Precargador -->
  <div class="preloader">
    <div class="spinner"></div>
    <div class="preloader-text">Cargando experiencia AR...</div>
  </div>

  <!-- Indicador de carga de c√°mara -->
  <div class="camera-loading" id="camera-loading" style="display: none;">
    <div class="spinner"></div>
    <div class="camera-loading-text">Iniciando c√°mara...</div>
  </div>

  <!-- Panel de instrucciones inicial -->
  <div class="instruction-panel" id="initial-instruction">
    <h2>üêé Caballo AR</h2>
    <p>Vive la experiencia de tener un caballo animado en tu espacio mediante realidad aumentada.</p>
    <button id="start-ar-btn">Comenzar Experiencia</button>
  </div>

  <!-- Ayuda para permisos de iOS -->
  <div class="ios-permission-help" id="ios-help">
    <h3>Permiso de c√°mara requerido</h3>
    <p>Para usar la realidad aumentada, necesitas permitir el acceso a la c√°mara:</p>
    <ul>
      <li>Haz clic en "Permitir" cuando Safari lo solicite</li>
      <li>Si accidentalmente hiciste clic en "Denegar", actualiza la p√°gina e intenta de nuevo</li>
      <li>Aseg√∫rate de que Safari tenga permisos de c√°mara en Configuraci√≥n > Safari</li>
    </ul>
    <button id="close-ios-help">Entendido</button>
  </div>

  <!-- Gu√≠a de alineaci√≥n -->
  <div id="alignment-guide">
    <div class="guide-line"></div>
    <div class="guide-text">Posiciona el celular para que la vista del piso se alinee con esta l√≠nea</div>
  </div>

  <!-- Bot√≥n para mostrar el caballo -->
  <button id="show-horse-btn">Mostrar Caballo</button>

  <!-- Capa para prevenir interacciones no deseadas -->
  <div class="prevent-touch" id="touch-blocker" style="display: none;"></div>

  <!-- Contenedor de la escena AR -->
  <div id="scene-container">
    <a-scene
      vr-mode-ui="enabled: false"
      loading-screen="enabled: false"
      embedded
      arjs="sourceType: webcam; facingMode: environment; debugUIEnabled: false;"
      gesture-detector="enabled: false"
      cursor="rayOrigin: mouse"
      id="ar-scene">
      
      <a-assets>
        <!-- Modelo de caballo de ejemplo (reemplaza con tu modelo real) -->
        <a-asset-item id="horse-model" src="https://cdn.glitch.global/5e54f704-5fe0-4c62-89b4-60c68d3d6567/horse.glb?v=1647282360083"></a-asset-item>
      </a-assets>

      <!-- Marcador AR (si est√°s usando marcadores) -->
      <!-- <a-marker type="pattern" preset="hiro"> -->
      <!-- Marcador prescindible para AR sin marcador -->
      <a-entity id="marker" visible="false">
        <!-- Caballo en el mundo AR (inicialmente oculto) -->
        <a-entity 
          id="horse-entity" 
          gltf-model="#horse-model" 
          position="0 0 0" 
          scale="0.5 0.5 0.5" 
          rotation="0 180 0"
          visible="false"
          animation-mixer="loop: repeat">
        </a-entity>
      </a-entity>
      <!-- </a-marker> -->

      <!-- C√°mara AR -->
      <a-entity id="ar-camera" camera></a-entity>
      
    </a-scene>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const preloader = document.querySelector('.preloader');
      const initialInstruction = document.getElementById('initial-instruction');
      const alignmentGuide = document.getElementById('alignment-guide');
      const showHorseBtn = document.getElementById('show-horse-btn');
      const sceneContainer = document.getElementById('scene-container');
      const startArBtn = document.getElementById('start-ar-btn');
      const touchBlocker = document.getElementById('touch-blocker');
      const iosHelp = document.getElementById('ios-help');
      const closeIosHelp = document.getElementById('close-ios-help');
      const cameraLoading = document.getElementById('camera-loading');
      const arScene = document.getElementById('ar-scene');
      
      let horseVisible = false;
      let arStarted = false;
      let isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
      let cameraAccessGranted = false;

      // Precargar el modelo antes de iniciar
      const horseEntity = document.getElementById('horse-entity');
      
      // Deshabilitar interacciones por defecto
      document.addEventListener('touchmove', function(e) {
        if (!horseVisible) {
          e.preventDefault();
        }
      }, { passive: false });
      
      // Simular precarga
      setTimeout(() => {
        preloader.style.display = 'none';
        initialInstruction.style.display = 'block';
        
        // Mostrar ayuda para iOS inmediatamente
        if (isIOS) {
          setTimeout(() => {
            iosHelp.style.display = 'block';
          }, 500);
        }
      }, 2000);

      // Cerrar ayuda de iOS
      closeIosHelp.addEventListener('click', function() {
        iosHelp.style.display = 'none';
      });

      // Iniciar experiencia AR
      startArBtn.addEventListener('click', function() {
        initialInstruction.style.display = 'none';
        iosHelp.style.display = 'none';
        cameraLoading.style.display = 'flex';
        
        // Para iOS, usar getUserMedia primero para manejar mejor los permisos
        if (isIOS) {
          initIOSCamera();
        } else {
          startARExperience();
        }
      });

      function startARExperience() {
        // Esperar a que la escena est√© cargada antes de mostrar
        if (arScene.hasLoaded) {
          showARScene();
        } else {
          arScene.addEventListener('loaded', showARScene);
        }
      }

      function showARScene() {
        sceneContainer.style.opacity = '1';
        alignmentGuide.style.display = 'flex';
        showHorseBtn.style.display = 'block';
        touchBlocker.style.display = 'block';
        cameraLoading.style.display = 'none';
        arStarted = true;
        
        // Asegurarse de que el modelo est√© oculto al iniciar
        horseEntity.setAttribute('visible', 'false');
        horseVisible = false;
        
        // Forzar el reinicio de la c√°mara en iOS si es necesario
        if (isIOS && cameraAccessGranted) {
          setTimeout(() => {
            const cameraSystem = arScene.systems['arjs'];
            if (cameraSystem && cameraSystem._arSource) {
              try {
                cameraSystem._arSource.stop();
                cameraSystem._arSource.init().then(() => {
                  console.log('C√°mara reiniciada correctamente');
                  cameraSystem._arSource.copySizeTo(arScene.renderer.domElement);
                  cameraSystem._arSource.onResize();
                }).catch(error => {
                  console.error('Error al reiniciar la c√°mara:', error);
                });
              } catch (error) {
                console.error('Error al acceder a la c√°mara:', error);
              }
            }
          }, 500);
        }
      }

      // Funci√≥n especial para manejar la c√°mara en iOS
      function initIOSCamera() {
        // Primero solicitar permisos de c√°mara directamente
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
          navigator.mediaDevices.getUserMedia({ video: true })
            .then(function(stream) {
              // Permiso concedido
              cameraAccessGranted = true;
              
              // Detener el stream ya que A-Frame lo manejar√° por su cuenta
              stream.getTracks().forEach(track => track.stop());
              
              // Iniciar AR
              startARExperience();
            })
            .catch(function(error) {
              // Permiso denegado o error
              console.error('Error al acceder a la c√°mara:', error);
              cameraLoading.style.display = 'none';
              
              // Mostrar mensaje de error
              alert('Para usar la realidad aumentada, necesitas permitir el acceso a la c√°mara. Por favor, actualiza la p√°gina e intenta de nuevo.');
              
              // Volver a mostrar las instrucciones iniciales
              initialInstruction.style.display = 'block';
              if (isIOS) {
                iosHelp.style.display = 'block';
              }
            });
        } else {
          // Navegador no compatible, intentar iniciar de todos modos
          startARExperience();
        }
      }

      // Mostrar el caballo
      showHorseBtn.addEventListener('click', function() {
        if (!horseVisible && arStarted) {
          horseEntity.setAttribute('visible', 'true');
          horseVisible = true;
          
          // Ocultar la gu√≠a de alineaci√≥n
          alignmentGuide.style.opacity = '0';
          
          // Ocultar el bot√≥n
          showHorseBtn.style.opacity = '0';
          
          // Quitar el bloqueador de toques
          touchBlocker.style.display = 'none';
          
          // Mostrar mensaje de √©xito
          const successMsg = document.createElement('div');
          successMsg.className = 'success-message';
          successMsg.innerHTML = '‚úÖ Caballo posicionado en tu espacio';
          document.body.appendChild(successMsg);
          
          // Remover mensaje despu√©s de 3 segundos
          setTimeout(() => {
            if (successMsg.parentNode) {
              successMsg.parentNode.removeChild(successMsg);
            }
          }, 3000);
        }
      });

      // Manejar eventos de la c√°mara
      arScene.addEventListener('camera-error', function(evt) {
        console.error('Error de c√°mara:', evt.detail.error);
        cameraLoading.querySelector('.camera-loading-text').textContent = 
          'Error al acceder a la c√°mara. Por favor, recarga la p√°gina.';
        
        setTimeout(() => {
          cameraLoading.style.display = 'none';
          initialInstruction.style.display = 'block';
        }, 3000);
      });

      // Prevenir el comportamiento por defecto de desplazamiento
      document.addEventListener('touchstart', function(e) {
        if (e.touches.length > 1) {
          e.preventDefault();
        }
      }, { passive: false });
      
      document.addEventListener('touchmove', function(e) {
        if (e.touches.length > 1) {
          e.preventDefault();
        }
      }, { passive: false });
    });
  </script>
</body>
</html>
